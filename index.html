<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grow a Garden Stock + Weather + Calculate + Info</title>
  <link rel="icon" href="icon.svg" type="image/svg+xml" />
  <!-- Google Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Use Poppins font */
    body {
      font-family: 'Poppins', sans-serif;
    }

    /* Dark mode styles */
    body.dark {
      background-color: #1a202c; /* Tailwind slate-900 */
      color: #cbd5e1; /* Tailwind slate-300 */
    }
    body.dark #output {
      background-color: #2d3748; /* slate-800 */
      color: #cbd5e1;
    }
    body.dark .category {
      background-color: rgba(45, 55, 72, 0.7) !important;
    }
    body.dark .new-item {
      box-shadow: 0 0 12px 4px rgba(72, 187, 120, 0.9);
      background: linear-gradient(90deg, #38b2ac, #68d391);
      animation: fadeInHighlight 3s ease forwards;
    }
    body.dark header p {
      color: #94a3b8; /* slate-400 */
    }
    body.dark #error {
      background-color: #742a2a;
      color: #fef2f2;
    }
    body.dark button.settings-btn {
      background-color: #2d3748;
      color: #a0aec0;
    }
    body.dark button.settings-btn:hover {
      background-color: #4a5568;
    }
    body.dark .dropdown-content {
      background-color: #2d3748;
      color: #cbd5e1;
    }

    /* Animations */
    @keyframes fadeInHighlight {
      0% {
        background: linear-gradient(90deg, #a7f3d0, #6ee7b7);
        box-shadow: 0 0 12px 4px rgba(34,197,94,0.8);
      }
      100% {
        background: transparent;
        box-shadow: none;
      }
    }

    .new-item {
      animation: fadeInHighlight 3s ease forwards;
    }

    /* Category gradient backgrounds */
    .category-seeds {
      background: linear-gradient(to right, #d1fae5, #6ee7b7);
    }
    .category-gear {
      background: linear-gradient(to right, #dbeafe, #3b82f6);
    }
    .category-eggs {
      background: linear-gradient(to right, #fef3c7, #fbbf24);
    }
    .category-cosmetics {
      background: linear-gradient(to right, #ede9fe, #8b5cf6);
    }
    .category-eventshop {
      background: linear-gradient(to right, #fed7aa, #fb923c);
    }
    .category-weather {
      background: linear-gradient(to right, #bae6fd, #38bdf8);
    }

    /* Dropdown styles */
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropdown-button {
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      z-index: 100;
      min-width: 180px;
      max-width: 300px;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      background: white;
      color: black;
      top: 110%;
      left: 50%;
      transform: translateX(-50%);
      transition: opacity 0.3s ease, transform 0.3s ease;
      opacity: 0;
      pointer-events: none;
      font-size: 0.9rem;
    }
    body.dark .dropdown-content {
      background-color: #2d3748;
      color: #cbd5e1;
      box-shadow: 0 4px 6px rgba(0,0,0,0.7);
    }
    .dropdown-content.show {
      display: block;
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }
    .dropdown-content p {
      margin: 0.25rem 0;
      line-height: 1.3;
    }

    /* Settings button */
    #settings-button {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background-color: #e2e8f0; /* gray-200 */
      color: #1f2937; /* gray-800 */
      border: none;
      padding: 0.5rem 0.75rem;
      border-radius: 0.375rem;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
      z-index: 200;
      box-shadow: 0 2px 4px rgb(0 0 0 / 0.1);
    }
    #settings-button:hover {
      background-color: #cbd5e1;
    }
    body.dark #settings-button {
      background-color: #4a5568;
      color: #e2e8f0;
    }
    body.dark #settings-button:hover {
      background-color: #2d3748;
    }

  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center p-6 text-gray-900">

  <button id="settings-button" aria-label="Toggle light/dark mode" title="Toggle Light/Dark Mode">ðŸŒ— Mode</button>

  <header class="mb-6 select-none max-w-3xl w-full text-center">
    <h1 class="text-4xl font-extrabold text-green-700 mb-2">Grow a Garden Stock + Weather + Calculate + Info</h1>
    <p class="text-gray-600">Live stock, weather, fruit calculations, and item info from Grow a Garden API</p>
  </header>

  <form id="filters" aria-label="Select categories" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4 max-w-3xl w-full mb-8 select-none">
    <label class="cursor-pointer flex items-center space-x-2 bg-white rounded-lg shadow-md p-3 hover:bg-blue-50 transition">
      <input type="checkbox" id="weather" checked class="w-5 h-5 cursor-pointer"/>
      <span class="font-semibold text-blue-700">Weather</span>
    </label>
    <label class="cursor-pointer flex items-center space-x-2 bg-white rounded-lg shadow-md p-3 hover:bg-green-50 transition">
      <input type="checkbox" id="seeds" checked class="w-5 h-5 cursor-pointer"/>
      <span class="font-semibold text-green-700">Seeds</span>
    </label>
    <label class="cursor-pointer flex items-center space-x-2 bg-white rounded-lg shadow-md p-3 hover:bg-blue-50 transition">
      <input type="checkbox" id="gear" checked class="w-5 h-5 cursor-pointer"/>
      <span class="font-semibold text-blue-700">Gear</span>
    </label>
    <label class="cursor-pointer flex items-center space-x-2 bg-white rounded-lg shadow-md p-3 hover:bg-yellow-50 transition">
      <input type="checkbox" id="eggs" checked class="w-5 h-5 cursor-pointer"/>
      <span class="font-semibold text-yellow-700">Eggs</span>
    </label>
    <label class="cursor-pointer flex items-center space-x-2 bg-white rounded-lg shadow-md p-3 hover:bg-purple-50 transition">
      <input type="checkbox" id="cosmetics" checked class="w-5 h-5 cursor-pointer"/>
      <span class="font-semibold text-purple-700">Cosmetics</span>
    </label>
    <label class="cursor-pointer flex items-center space-x-2 bg-white rounded-lg shadow-md p-3 hover:bg-orange-50 transition">
      <input type="checkbox" id="eventshop" checked class="w-5 h-5 cursor-pointer"/>
      <span class="font-semibold text-orange-700">Event Shop</span>
    </label>
  </form>

  <main id="output" role="region" aria-live="polite" aria-busy="false" tabindex="0" class="max-w-3xl w-full bg-white rounded-lg shadow-lg p-6 min-h-[240px] select-none"></main>

  <div id="error" role="alert" aria-live="assertive" class="max-w-3xl w-full mt-6 bg-red-100 text-red-700 font-semibold p-4 rounded-lg shadow-md hidden select-none"></div>

  <section id="calculate-section" class="max-w-3xl w-full bg-white rounded-lg shadow-lg p-6 mt-10 mb-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-4 select-none">Calculate Fruit Value</h2>
    <form id="calculate-form" class="flex flex-col sm:flex-row gap-4">
      <select id="item-select" class="border border-gray-300 rounded-md px-3 py-2 flex-grow" aria-label="Select item for calculation">
        <option value="" disabled selected>Select an item...</option>
      </select>
      <input type="number" id="weight-input" placeholder="Weight (g)" min="1" class="border border-gray-300 rounded-md px-3 py-2 w-28" aria-label="Weight in grams" required />
      <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md font-semibold transition">Calculate</button>
    </form>
    <pre id="calculation-result" class="mt-4 text-gray-700 font-mono whitespace-pre-wrap"></pre>
  </section>

  <!-- Modal for item info -->
  <div id="info-modal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="modal-backdrop absolute inset-0 bg-black bg-opacity-40"></div>
    <div class="bg-white rounded-lg shadow-xl max-w-md mx-4 p-6 relative z-10 max-h-[80vh] overflow-auto">
      <button id="close-modal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-900" aria-label="Close info modal" title="Close">&times;</button>
      <div id="info-content" tabindex="0" class="outline-none"></div>
    </div>
  </div>

  <script>
    (() => {
      const output = document.getElementById('output');
      const errorBox = document.getElementById('error');
      const filtersForm = document.getElementById('filters');
      const itemSelect = document.getElementById('item-select');
      const calcForm = document.getElementById('calculate-form');
      const calcResult = document.getElementById('calculation-result');
      const modal = document.getElementById('info-modal');
      const modalContent = document.getElementById('info-content');
      const closeModalBtn = document.getElementById('close-modal');
      const settingsBtn = document.getElementById('settings-button');

      const categories = {
        seeds: { key: 'seed_stock', title: 'Seeds', cssClass: 'category-seeds' },
        gear: { key: 'gear_stock', title: 'Gear', cssClass: 'category-gear' },
        eggs: { key: 'egg_stock', title: 'Eggs', cssClass: 'category-eggs' },
        cosmetics: { key: 'cosmetic_stock', title: 'Cosmetics', cssClass: 'category-cosmetics' },
        eventshop: { key: 'eventshop_stock', title: 'Event Shop', cssClass: 'category-eventshop' },
      };

      let prevItems = {
        seed_stock: new Set(),
        gear_stock: new Set(),
        egg_stock: new Set(),
        cosmetic_stock: new Set(),
        eventshop_stock: new Set(),
      };

      let allItemsMap = new Map(); // item_id => data

      // Rate limit control: max 1 fetch per 5 seconds
      let lastFetchTime = 0;

      const createSpinner = () => `
        <div class="flex justify-center my-16" role="status" aria-live="polite" aria-busy="true">
          <svg class="animate-spin h-12 w-12 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
          </svg>
          <span class="sr-only">Loading...</span>
        </div>
      `;

      // Render weather
      const renderWeather = (weatherArr) => {
        if (!Array.isArray(weatherArr) || weatherArr.length === 0) return null;

        const activeWeather = weatherArr.find(w => w.active) || weatherArr[0];
        if (!activeWeather) return null;

        const { weather_name, duration = 0, start_duration_unix = 0, end_duration_unix = 0, icon } = activeWeather;
        const startDate = new Date(start_duration_unix * 1000).toLocaleTimeString();
        const endDate = new Date(end_duration_unix * 1000).toLocaleTimeString();

        const section = document.createElement('section');
        section.className = 'category mb-8 rounded-lg p-4 category-weather bg-opacity-20';
        section.setAttribute('aria-label', 'Weather');

        section.innerHTML = `
          <h2 class="text-2xl font-bold text-gray-800 mb-4">Weather</h2>
          <div class="flex items-center space-x-6 flex-wrap gap-4">
            <img src="${icon || ''}" alt="${weather_name} icon" class="w-16 h-16" loading="lazy" />
            <div class="text-lg font-semibold text-blue-800">${weather_name}</div>
            <div class="text-gray-700 font-mono">Duration: ${Math.floor(duration / 60)} mins</div>
            <div class="text-gray-700 font-mono">Start: ${startDate}</div>
            <div class="text-gray-700 font-mono">End: ${endDate}</div>
          </div>
        `;

        return section;
      };

      // Create dropdown menu for item details/prices
      function createDropdown(detailsHtml) {
        const dropdown = document.createElement('div');
        dropdown.className = 'dropdown-content rounded-md shadow-md';
        dropdown.innerHTML = detailsHtml;
        return dropdown;
      }

      // Toggle dropdown visibility with animation
      function toggleDropdown(dropdown) {
        const isShown = dropdown.classList.contains('show');
        if (isShown) {
          dropdown.classList.remove('show');
        } else {
          dropdown.classList.add('show');
        }
      }

      // Render stock category with dropdown price/details
      const renderStockCategory = (items, title, cssClass, key) => {
        const section = document.createElement('section');
        section.className = `category mb-8 rounded-lg p-4 ${cssClass} bg-opacity-20`;
        section.setAttribute('aria-label', title);

        section.innerHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-4">${title}</h2>`;

        items.forEach(item => {
          const isNew = !prevItems[key].has(item.item_id);
          if (isNew) prevItems[key].add(item.item_id);

          allItemsMap.set(item.item_id, item);

          // Main container for each item
          const article = document.createElement('article');
          article.className = `p-3 mb-3 rounded-lg border border-gray-200 bg-white flex items-center space-x-4 cursor-pointer select-text relative ${
            isNew ? 'new-item' : ''
          }`;
          article.setAttribute('tabindex', '0');
          article.setAttribute('role', 'button');
          article.setAttribute('aria-pressed', 'false');

          // Image + name + qty + dropdown button
          article.innerHTML = `
            <img src="${item.icon}" alt="${item.display_name} icon" class="w-12 h-12 rounded-md object-contain flex-shrink-0" loading="lazy" />
            <div class="flex-1">
              <div class="font-semibold text-green-900 text-lg">${item.display_name}</div>
            </div>
            <div class="text-gray-600 font-mono mr-4">Qty: ${item.quantity}</div>
            <div class="dropdown">
              <button aria-label="Show item details" class="dropdown-button text-green-700 hover:text-green-900 font-semibold select-none flex items-center gap-1">
                Details
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
            </div>
          `;

          // Create dropdown content container (hidden by default)
          const dropdownContainer = document.createElement('div');
          dropdownContainer.className = 'dropdown-content rounded-md shadow-md hidden max-w-xs';
          dropdownContainer.setAttribute('aria-hidden', 'true');

          article.querySelector('.dropdown').appendChild(dropdownContainer);

          // Dropdown button toggle event
          article.querySelector('.dropdown-button').addEventListener('click', async e => {
            e.stopPropagation();
            // Close all other dropdowns before opening this
            document.querySelectorAll('.dropdown-content.show').forEach(dc => {
              if (dc !== dropdownContainer) {
                dc.classList.remove('show');
                dc.setAttribute('aria-hidden', 'true');
              }
            });

            if (dropdownContainer.classList.contains('show')) {
              dropdownContainer.classList.remove('show');
              dropdownContainer.setAttribute('aria-hidden', 'true');
            } else {
              dropdownContainer.classList.add('show');
              dropdownContainer.setAttribute('aria-hidden', 'false');

              // If dropdown is empty, fetch info
              if (!dropdownContainer.dataset.loaded) {
                dropdownContainer.innerHTML = `<p class="text-gray-500">Loading...</p>`;
                try {
                  const res = await fetch(`https://api.joshlei.com/v2/growagarden/info/${item.item_id}`);
                  if (!res.ok) throw new Error(`HTTP ${res.status}`);
                  const data = await res.json();
                  let details = `<strong>${data.display_name || item.display_name}</strong><br/>`;
                  if (data.description) {
                    details += `<p class="mt-1 text-sm">${data.description}</p>`;
                  }
                  if (data.value) {
                    details += `<p class="mt-1 font-mono">Value: ${data.value}</p>`;
                  }
                  if (data.price) {
                    details += `<p class="mt-1 font-mono">Price: ${data.price}</p>`;
                  }
                  dropdownContainer.innerHTML = details || `<p>No details available.</p>`;
                } catch {
                  dropdownContainer.innerHTML = `<p class="text-red-500">Failed to load details.</p>`;
                }
                dropdownContainer.dataset.loaded = "true";
              }
            }
          });

          // Keyboard accessibility: open dropdown on Enter or Space
          article.addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              article.querySelector('.dropdown-button').click();
            }
          });

          section.appendChild(article);
        });

        return section;
      };

      // Populate calculate select with all stock items + fetch /info for name mapping
      async function populateCalculateSelect() {
        const types = ['seed_stock', 'gear_stock', 'egg_stock', 'cosmetic_stock', 'eventshop_stock'];
        let allItems = [];
        types.forEach(t => {
          if (prevItems[t]) {
            allItems = allItems.concat([...prevItems[t]].map(id => allItemsMap.get(id)));
          }
        });

        // Remove duplicates & sort by display_name
        const uniqueItems = Array.from(new Map(allItems.map(item => [item.item_id, item])).values());
        uniqueItems.sort((a, b) => a.display_name.localeCompare(b.display_name));

        itemSelect.innerHTML = `<option value="" disabled selected>Select an item...</option>`;
        uniqueItems.forEach(item => {
          const option = document.createElement('option');
          option.value = item.display_name;
          option.textContent = item.display_name;
          itemSelect.appendChild(option);
        });
      }

      // Calculate form submission handler
      calcForm.addEventListener('submit', async e => {
        e.preventDefault();
        const name = itemSelect.value;
        const weight = document.getElementById('weight-input').value;
        if (!name || !weight || weight <= 0) {
          calcResult.textContent = 'Please select an item and enter a valid weight.';
          return;
        }
        calcResult.textContent = 'Calculating...';

        try {
          const url = new URL('https://api.joshlei.com/v2/growagarden/calculate');
          url.searchParams.set('Name', name);
          url.searchParams.set('Weight', weight);
          const res = await fetch(url.toString());
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          calcResult.textContent = `Estimated value for ${data.Name} (${weight}g): ${data.value.toLocaleString()} coins`;
        } catch {
          calcResult.textContent = 'Failed to calculate value. Please try again later.';
        }
      });

      // Modal close
      closeModalBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
        modalContent.innerHTML = '';
      });

      // Close modal on outside click
      modal.addEventListener('click', e => {
        if (e.target === modal) {
          closeModalBtn.click();
        }
      });

      // Light/dark mode toggle logic
      function setDarkMode(isDark) {
        if (isDark) {
          document.body.classList.add('dark');
          localStorage.setItem('growagarden-darkmode', 'true');
          settingsBtn.textContent = 'ðŸŒž Mode';
        } else {
          document.body.classList.remove('dark');
          localStorage.setItem('growagarden-darkmode', 'false');
          settingsBtn.textContent = 'ðŸŒ— Mode';
        }
      }

      settingsBtn.addEventListener('click', () => {
        setDarkMode(!document.body.classList.contains('dark'));
      });

      // Initialize dark mode from storage or default
      setDarkMode(localStorage.getItem('growagarden-darkmode') === 'true');

      // Main fetch function
      async function fetchData() {
        const now = Date.now();
        if (now - lastFetchTime < 5000) return; // 5s throttle
        lastFetchTime = now;

        output.setAttribute('aria-busy', 'true');
        errorBox.classList.add('hidden');
        output.innerHTML = createSpinner();

        try {
          const [stockRes, weatherRes] = await Promise.all([
            fetch('https://api.joshlei.com/v2/growagarden/stock', {cache: 'no-store'}),
            fetch('https://api.joshlei.com/v2/growagarden/weather', {cache: 'no-store'}),
          ]);

          if (!stockRes.ok) throw new Error(`Stock API HTTP ${stockRes.status}`);
          if (!weatherRes.ok) throw new Error(`Weather API HTTP ${weatherRes.status}`);

          const stockData = await stockRes.json();
          const weatherData = await weatherRes.json();

          output.innerHTML = '';
          Object.keys(prevItems).forEach(k => prevItems[k].clear());
          allItemsMap.clear();

          // Render weather if checked
          if (document.getElementById('weather').checked && weatherData.weather?.length) {
            const weatherSection = renderWeather(weatherData.weather);
            if (weatherSection) output.appendChild(weatherSection);
          }

          // Render stock categories based on filter
          for (const [filterId, {key, title, cssClass}] of Object.entries(categories)) {
            if (!document.getElementById(filterId).checked) continue;
            const items = stockData[key] || [];
            const section = renderStockCategory(items, title, cssClass, key);
            output.appendChild(section);
          }

          await populateCalculateSelect();

        } catch (err) {
          output.innerHTML = '';
          errorBox.classList.remove('hidden');
          errorBox.textContent = 'Error Code 1: No internet or API limit reached. Please try again later.';
          console.error('Fetch error:', err);
        } finally {
          output.setAttribute('aria-busy', 'false');
        }
      }

      filtersForm.addEventListener('change', fetchData);

      fetchData();
      setInterval(fetchData, 5000);

    })();
  </script>
</body>
</html>
