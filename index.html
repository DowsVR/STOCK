<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grow a Garden Stock Viewer</title>
<link rel="icon" href="icon.svg" type="image/svg+xml" />
<script src="https://cdn.tailwindcss.com"></script>
<style>
  /* Skeuomorphic styling */
  body {
    font-family: 'Inter', sans-serif;
    transition: background-color 0.4s, color 0.4s;
    background: linear-gradient(135deg, #e2e8f0, #f8fafc);
  }
  body.dark {
    background: linear-gradient(135deg, #1f2937, #111827);
    color: #d1d5db;
  }
  .skeuocard {
    background: #f9fafb;
    border-radius: 1rem;
    box-shadow:
      inset 6px 6px 10px #d1d5db,
      inset -6px -6px 10px #ffffff;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
    transition: background-color 0.4s, box-shadow 0.4s;
  }
  body.dark .skeuocard {
    background: #111827;
    box-shadow:
      inset 6px 6px 10px #0f172a,
      inset -6px -6px 10px #1e293b;
  }
  .category h2 {
    font-weight: 700;
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: #334155;
  }
  body.dark .category h2 {
    color: #e0e7ff;
  }
  .item-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.8rem;
    cursor: pointer;
    padding: 0.5rem 1rem;
    border-radius: 0.75rem;
    box-shadow:
      5px 5px 10px #d1d5db,
      -5px -5px 10px #ffffff;
    background: #f1f5f9;
    transition: background-color 0.3s, box-shadow 0.3s;
  }
  .item-card:hover {
    box-shadow:
      inset 4px 4px 6px #cbd5e1,
      inset -4px -4px 6px #ffffff;
    background: #e2e8f0;
  }
  body.dark .item-card {
    background: #1e293b;
    box-shadow:
      5px 5px 10px #0f172a,
      -5px -5px 10px #1e293b;
  }
  body.dark .item-card:hover {
    box-shadow:
      inset 4px 4px 6px #0c1230,
      inset -4px -4px 6px #1e293b;
    background: #111827;
  }
  .item-name {
    flex-grow: 1;
    font-weight: 600;
    font-size: 1.1rem;
    color: #334155;
    user-select: none;
  }
  body.dark .item-name {
    color: #d1d5db;
  }
  .quantity {
    font-family: 'JetBrains Mono', monospace;
    color: #64748b;
    user-select: none;
  }
  body.dark .quantity {
    color: #94a3b8;
  }
  .dropdown-btn {
    border: none;
    background: transparent;
    cursor: pointer;
    font-weight: 600;
    color: #3b82f6;
    user-select: none;
    padding: 0;
    margin-left: 0.5rem;
    transition: color 0.3s;
  }
  .dropdown-btn:hover {
    color: #2563eb;
  }
  body.dark .dropdown-btn {
    color: #60a5fa;
  }
  body.dark .dropdown-btn:hover {
    color: #3b82f6;
  }
  .dropdown-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.35s ease;
    background: #f9fafb;
    padding: 0 1rem;
    border-radius: 0 0 1rem 1rem;
    box-shadow:
      inset 2px 2px 5px #d1d5db,
      inset -2px -2px 5px #ffffff;
    font-size: 0.95rem;
    color: #334155;
  }
  .dropdown-content.show {
    max-height: 15rem;
    padding: 0.5rem 1rem;
  }
  body.dark .dropdown-content {
    background: #111827;
    box-shadow:
      inset 2px 2px 5px #0f172a,
      inset -2px -2px 5px #1e293b;
    color: #cbd5e1;
  }
  .loading, .error-msg {
    text-align: center;
    font-size: 1.25rem;
    padding: 3rem 1rem;
    color: #6b7280;
  }
  body.dark .loading, body.dark .error-msg {
    color: #94a3b8;
  }
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 1.5rem;
    background: #f3f4f6;
    box-shadow: 0 3px 10px rgb(0 0 0 / 0.1);
    border-radius: 1rem;
    margin-bottom: 2rem;
  }
  body.dark .header {
    background: #1f2937;
    box-shadow: 0 3px 10px rgb(0 0 0 / 0.7);
  }
  .btn {
    font-weight: 600;
    padding: 0.5rem 1rem;
    border-radius: 0.75rem;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.3s, color 0.3s;
    border: none;
  }
  .btn-primary {
    background: #3b82f6;
    color: white;
    box-shadow: 0 4px 8px rgb(59 130 246 / 0.4);
  }
  .btn-primary:hover {
    background: #2563eb;
  }
  .btn-secondary {
    background: #e0e7ff;
    color: #1e40af;
  }
  .btn-secondary:hover {
    background: #c7d2fe;
  }
  body.dark .btn-primary {
    background: #2563eb;
    box-shadow: 0 4px 8px rgb(37 99 235 / 0.7);
  }
  body.dark .btn-primary:hover {
    background: #3b82f6;
  }
  body.dark .btn-secondary {
    background: #374151;
    color: #93c5fd;
  }
  body.dark .btn-secondary:hover {
    background: #4b5563;
  }
  .settings-btn {
    font-size: 1.2rem;
  }
</style>
</head>
<body class="transition-colors duration-500">

  <header class="header max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 select-none">ðŸŒ± Grow a Garden Stock Viewer</h1>
    <div>
      <button id="refreshBtn" class="btn btn-primary mr-3" title="Refresh stock">Refresh ðŸ”„</button>
      <button id="toggleModeBtn" class="btn btn-secondary settings-btn" title="Toggle Light/Dark Mode">ðŸŒ—</button>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 pb-12" id="content">

    <!-- Loading and Error placeholder -->
    <div id="statusMessage" class="loading select-none">Loading stock...</div>

  </main>

<script>
(() => {
  'use strict';

  const API_BASE = 'https://api.joshlei.com/v2/growagarden';
  const content = document.getElementById('content');
  const statusMessage = document.getElementById('statusMessage');
  const refreshBtn = document.getElementById('refreshBtn');
  const toggleModeBtn = document.getElementById('toggleModeBtn');

  // State
  let darkMode = localStorage.getItem('darkMode') === 'true';
  document.body.classList.toggle('dark', darkMode);

  // Toggle Dark Mode
  toggleModeBtn.addEventListener('click', () => {
    darkMode = !darkMode;
    document.body.classList.toggle('dark', darkMode);
    localStorage.setItem('darkMode', darkMode);
  });

  // Helper: Create elements with classes and text
  function el(type, classNames = '', text) {
    const e = document.createElement(type);
    if (classNames) e.className = classNames;
    if (text !== undefined) e.textContent = text;
    return e;
  }

  // Render item card with dropdown details
  function renderItem(item, category) {
    const card = el('div', 'item-card', '');
    card.setAttribute('tabindex', '0');
    card.setAttribute('role', 'button');
    card.setAttribute('aria-expanded', 'false');
    card.setAttribute('aria-label', `${item.display_name} details`);

    // Icon image
    const icon = document.createElement('img');
    icon.src = item.icon;
    icon.alt = item.display_name;
    icon.className = 'w-12 h-12 rounded-lg flex-shrink-0';
    card.appendChild(icon);

    // Name + quantity
    const nameDiv = el('div', 'item-name', item.display_name);
    card.appendChild(nameDiv);

    // Quantity + price container
    const qtyPrice = el('div', 'flex flex-col items-end space-y-0.5');
    const quantity = el('div', 'quantity', `Qty: ${item.quantity}`);
    qtyPrice.appendChild(quantity);

    // Price: show "Sheckels"
    if (item.price !== undefined) {
      const price = el('div', 'quantity', `Price: ${item.price} Sheckels`);
      qtyPrice.appendChild(price);
    }

    card.appendChild(qtyPrice);

    // Dropdown toggle button
    const dropdownBtn = el('button', 'dropdown-btn');
    dropdownBtn.textContent = 'Details â–¼';
    dropdownBtn.setAttribute('aria-expanded', 'false');
    dropdownBtn.setAttribute('aria-controls', `details-${category}-${item.item_id}`);
    dropdownBtn.setAttribute('type', 'button');

    card.appendChild(dropdownBtn);

    // Dropdown details container
    const dropdownContent = el('div', 'dropdown-content');
    dropdownContent.id = `details-${category}-${item.item_id}`;
    dropdownContent.setAttribute('aria-hidden', 'true');
    card.appendChild(dropdownContent);

    // Toggle dropdown logic
    dropdownBtn.addEventListener('click', async e => {
      e.stopPropagation();

      const isOpen = dropdownContent.classList.contains('show');

      // Close all other dropdowns
      document.querySelectorAll('.dropdown-content.show').forEach(dc => {
        if (dc !== dropdownContent) {
          dc.classList.remove('show');
          dc.setAttribute('aria-hidden', 'true');
        }
      });
      document.querySelectorAll('.dropdown-btn[aria-expanded="true"]').forEach(btn => {
        if (btn !== dropdownBtn) btn.setAttribute('aria-expanded', 'false');
      });

      if (isOpen) {
        dropdownContent.classList.remove('show');
        dropdownContent.setAttribute('aria-hidden', 'true');
        dropdownBtn.setAttribute('aria-expanded', 'false');
      } else {
        dropdownContent.classList.add('show');
        dropdownContent.setAttribute('aria-hidden', 'false');
        dropdownBtn.setAttribute('aria-expanded', 'true');

        if (!dropdownContent.dataset.loaded) {
          dropdownContent.innerHTML = `<p class="text-gray-500 dark:text-gray-400 select-none">Loading details...</p>`;
          try {
            const res = await fetch(`${API_BASE}/info/${item.item_id}`, {cache: 'no-store'});
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();

            // Build details html cleanly
            let detailsHtml = '';
            if (data.display_name) detailsHtml += `<strong>${data.display_name}</strong><br/>`;
            if (data.description) detailsHtml += `<p class="mt-1 text-sm">${data.description}</p>`;
            if (data.value !== undefined) detailsHtml += `<p class="mt-1 font-mono">Value: ${data.value}</p>`;
            if (data.price !== undefined) detailsHtml += `<p class="mt-1 font-mono">Price: ${data.price} Sheckels</p>`;

            dropdownContent.innerHTML = detailsHtml || `<p>No details available.</p>`;
          } catch {
            dropdownContent.innerHTML = `<p class="text-red-500 select-none">Failed to load details.</p>`;
          }
          dropdownContent.dataset.loaded = "true";
        }
      }
    });

    return card;
  }

  // Render category section with items
  function renderCategory(title, items, categoryKey) {
    if (!items || items.length === 0) return null;

    const section = el('section', 'category skeuocard');
    const h2 = el('h2', '', title);
    section.appendChild(h2);

    items.forEach(item => {
      section.appendChild(renderItem(item, categoryKey));
    });

    return section;
  }

  // Render weather - only the first active weather event
  function renderWeather(weatherArray) {
    if (!weatherArray || weatherArray.length === 0) return null;
    const activeWeather = weatherArray.find(w => w.active);
    if (!activeWeather) return null;

    const section = el('section', 'category skeuocard');
    const h2 = el('h2', '', 'Current Weather');
    section.appendChild(h2);

    const article = el('article', 'flex items-center gap-4 select-none');
    article.setAttribute('tabindex', '0');

    const img = el('img');
    img.src = activeWeather.icon;
    img.alt = activeWeather.weather_name;
    img.className = 'w-14 h-14 rounded-lg flex-shrink-0';
    article.appendChild(img);

    const name = el('div', 'item-name font-semibold text-lg', activeWeather.weather_name);
    article.appendChild(name);

    const durationMin = Math.round(activeWeather.duration / 60);
    const duration = el('div', 'quantity', `Duration: ${durationMin} min`);
    article.appendChild(duration);

    section.appendChild(article);

    return section;
  }

  // Show loading or error message
  function showStatus(message, isError = false) {
    statusMessage.textContent = message;
    statusMessage.className = isError ? 'error-msg select-none' : 'loading select-none';
  }

  // Fetch and render all
  async function fetchAndRender() {
    showStatus('Loading stock...');
    content.innerHTML = '';
    content.appendChild(statusMessage);

    try {
      const resStock = await fetch(`${API_BASE}/stock`, {cache: 'no-store'});
      if (!resStock.ok) throw new Error(`Stock HTTP ${resStock.status}`);
      const stockData = await resStock.json();

      const resWeather = await fetch(`${API_BASE}/weather`, {cache: 'no-store'});
      if (!resWeather.ok) throw new Error(`Weather HTTP ${resWeather.status}`);
      const weatherData = await resWeather.json();

      // Remove status message on success
      statusMessage.remove();

      // Render stock categories
      const categories = [
        {key: 'seed_stock', title: 'Seeds'},
        {key: 'gear_stock', title: 'Gear'},
        {key: 'egg_stock', title: 'Eggs'},
        {key: 'cosmetic_stock', title: 'Cosmetics'},
        {key: 'eventshop_stock', title: 'Event Shop'},
        {key: 'travelingmerchant_stock', title: 'Traveling Merchant'},
      ];

      categories.forEach(cat => {
        const section = renderCategory(cat.title, stockData[cat.key], cat.key);
        if (section) content.appendChild(section);
      });

      // Render weather
      const weatherSection = renderWeather(weatherData.weather);
      if (weatherSection) content.appendChild(weatherSection);

    } catch (err) {
      showStatus('Error loading data, please try again later.', true);
      console.error(err);
    }
  }

  // Initial load
  fetchAndRender();

  // Manual refresh
  refreshBtn.addEventListener('click', () => {
    fetchAndRender();
  });

  // Close dropdowns on outside click
  document.body.addEventListener('click', () => {
    document.querySelectorAll('.dropdown-content.show').forEach(dc => {
      dc.classList.remove('show');
      dc.setAttribute('aria-hidden', 'true');
    });
    document.querySelectorAll('.dropdown-btn[aria-expanded="true"]').forEach(btn => {
      btn.setAttribute('aria-expanded', 'false');
    });
  });

})();
</script>

</body>
</html>
