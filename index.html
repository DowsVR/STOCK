<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grow a Garden Stock + Weather + Calculate + Info</title>
  <link rel="icon" href="icon.svg" type="image/svg+xml" />
  <!-- Google Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Skeuomorphic base styles */
    body {
      font-family: 'Poppins', sans-serif;
      background: #e0e0e0;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
      transition: background 0.3s ease, color 0.3s ease;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    body.dark {
      background: #22262e;
      color: #cbd5e1;
    }

    /* Skeuomorphic cards */
    .skeuocard {
      background: #e6e6e6;
      border-radius: 16px;
      box-shadow:
        6px 6px 12px #bebebe,
        -6px -6px 12px #ffffff;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    body.dark .skeuocard {
      background: #2a2e37;
      box-shadow:
        6px 6px 12px #1e2127,
        -6px -6px 12px #343a45;
    }

    /* Header */
    header {
      text-align: center;
      max-width: 900px;
      margin-bottom: 2rem;
      user-select: none;
    }
    header h1 {
      font-weight: 900;
      font-size: 2.75rem;
      color: #3a9a5a;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      margin-bottom: 0.5rem;
    }
    body.dark header h1 {
      color: #5de57d;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
    }
    header p {
      font-weight: 500;
      color: #666;
    }
    body.dark header p {
      color: #b0bec5;
    }

    /* Filters */
    #filters {
      max-width: 900px;
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(120px,1fr));
      gap: 1rem;
      margin-bottom: 2rem;
      user-select: none;
    }
    #filters label {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: #e6e6e6;
      padding: 1rem;
      border-radius: 16px;
      box-shadow:
        inset 4px 4px 6px #bebebe,
        inset -4px -4px 6px #ffffff;
      font-weight: 600;
      color: #2d6a3a;
      transition: box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease;
    }
    body.dark #filters label {
      background: #2a2e37;
      color: #86c68b;
      box-shadow:
        inset 4px 4px 6px #1e2127,
        inset -4px -4px 6px #343a45;
    }
    #filters label:hover,
    #filters label input:checked + span {
      background: #c0e6b7;
      box-shadow:
        4px 4px 6px #a3c79d,
        -4px -4px 6px #d7f0c2;
      color: #2b5426;
    }
    body.dark #filters label:hover,
    body.dark #filters label input:checked + span {
      background: #5aad5a;
      box-shadow:
        4px 4px 6px #487a49,
        -4px -4px 6px #7dc27a;
      color: #b3ef9c;
    }
    #filters input[type="checkbox"] {
      width: 24px;
      height: 24px;
      accent-color: #3a9a5a;
    }
    body.dark #filters input[type="checkbox"] {
      accent-color: #5de57d;
    }

    /* Main output container */
    #output {
      max-width: 900px;
      width: 100%;
      background: #e6e6e6;
      border-radius: 16px;
      box-shadow:
        6px 6px 12px #bebebe,
        -6px -6px 12px #ffffff;
      padding: 2rem;
      min-height: 260px;
      color: #2f4f2f;
      user-select: none;
      overflow-y: auto;
      transition: background 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
    }
    body.dark #output {
      background: #2a2e37;
      color: #b0d8ac;
      box-shadow:
        6px 6px 12px #1e2127,
        -6px -6px 12px #343a45;
    }

    /* Categories styling */
    .category {
      margin-bottom: 2rem;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      background: #f0f0f0;
      box-shadow:
        inset 4px 4px 6px #bebebe,
        inset -4px -4px 6px #ffffff;
      transition: background 0.3s ease;
      user-select: text;
    }
    body.dark .category {
      background: #242832;
      box-shadow:
        inset 4px 4px 6px #1e2127,
        inset -4px -4px 6px #343a45;
    }
    .category h2 {
      font-weight: 700;
      color: #3a9a5a;
      margin-bottom: 1rem;
      user-select: none;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    body.dark .category h2 {
      color: #5de57d;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
    }

    /* Individual item card */
    article {
      background: #e6e6e6;
      border-radius: 14px;
      box-shadow:
        6px 6px 8px #bebebe,
        -6px -6px 8px #ffffff;
      margin-bottom: 1rem;
      padding: 1rem 1.25rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      user-select: text;
      transition: box-shadow 0.2s ease, background 0.2s ease;
    }
    body.dark article {
      background: #2a2e37;
      box-shadow:
        6px 6px 8px #1e2127,
        -6px -6px 8px #343a45;
    }
    article:hover,
    article:focus-visible {
      box-shadow:
        8px 8px 10px #b1b1b1,
        -8px -8px 10px #ffffff;
      outline: none;
      background: #d4e7ce;
      color: #1a4f20;
    }
    body.dark article:hover,
    body.dark article:focus-visible {
      box-shadow:
        8px 8px 10px #17201c,
        -8px -8px 10px #3a4a3b;
      background: #3a4f3c;
      color: #9bdb89;
    }

    /* Item image */
    article img {
      width: 48px;
      height: 48px;
      object-fit: contain;
      border-radius: 8px;
      user-select: none;
      flex-shrink: 0;
    }

    /* Item name */
    .item-name {
      flex-grow: 1;
      font-weight: 700;
      font-size: 1.125rem;
      color: #2f553f;
      user-select: text;
    }
    body.dark .item-name {
      color: #a5dba0;
    }

    /* Quantity text */
    .quantity {
      font-family: monospace;
      font-weight: 600;
      color: #4f7942;
      user-select: text;
    }
    body.dark .quantity {
      color: #7ec17e;
    }

    /* Dropdown button */
    .dropdown-button {
      background: #e6e6e6;
      border-radius: 12px;
      box-shadow:
        inset 3px 3px 6px #bebebe,
        inset -3px -3px 6px #ffffff;
      padding: 0.35rem 0.75rem;
      font-weight: 600;
      color: #3a9a5a;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      user-select: none;
      cursor: pointer;
      transition: box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease;
      border: none;
    }
    body.dark .dropdown-button {
      background: #2a2e37;
      color: #5de57d;
      box-shadow:
        inset 3px 3px 6px #1e2127,
        inset -3px -3px 6px #343a45;
    }
    .dropdown-button:hover,
    .dropdown-button:focus-visible {
      background: #c0e6b7;
      color: #276b25;
      box-shadow:
        3px 3px 6px #a3c79d,
        -3px -3px 6px #d7f0c2;
      outline: none;
    }
    body.dark .dropdown-button:hover,
    body.dark .dropdown-button:focus-visible {
      background: #5aad5a;
      color: #2d602a;
      box-shadow:
        3px 3px 6px #487a49,
        -3px -3px 6px #7dc27a;
      outline: none;
    }

    /* Dropdown content */
    .dropdown-content {
      position: absolute;
      margin-top: 0.5rem;
      padding: 1rem;
      background: #e6e6e6;
      border-radius: 16px;
      box-shadow:
        8px 8px 12px #bebebe,
        -8px -8px 12px #ffffff;
      max-width: 320px;
      color: #2f553f;
      font-size: 0.9rem;
      user-select: text;
      opacity: 0;
      transform: translateY(-8px);
      transition: opacity 0.25s ease, transform 0.25s ease;
      pointer-events: none;
      z-index: 50;
    }
    body.dark .dropdown-content {
      background: #2a2e37;
      color: #a5dba0;
      box-shadow:
        8px 8px 12px #1e2127,
        -8px -8px 12px #343a45;
    }
    .dropdown-content.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    /* Calculation section */
    #calculate-section {
      max-width: 900px;
      width: 100%;
      margin-top: 3rem;
      background: #e6e6e6;
      border-radius: 16px;
      box-shadow:
        6px 6px 12px #bebebe,
        -6px -6px 12px #ffffff;
      padding: 2rem 2.5rem;
      color: #2f553f;
      user-select: none;
      transition: background 0.3s ease, box-shadow 0.3s ease, color 0.3s ease;
    }
    body.dark #calculate-section {
      background: #2a2e37;
      color: #a5dba0;
      box-shadow:
        6px 6px 12px #1e2127,
        -6px -6px 12px #343a45;
    }

    /* Calculation form */
    #calculate-form {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    #calculate-form select,
    #calculate-form input[type="number"] {
      border: none;
      padding: 0.75rem 1rem;
      border-radius: 16px;
      box-shadow:
        inset 6px 6px 8px #bebebe,
        inset -6px -6px 8px #ffffff;
      font-size: 1rem;
      font-weight: 600;
      color: #2f553f;
      user-select: text;
      transition: box-shadow 0.2s ease, background 0.2s ease, color 0.2s ease;
      min-width: 180px;
      flex-grow: 1;
      max-width: 100%;
    }
    #calculate-form select:focus,
    #calculate-form input[type="number"]:focus {
      outline: none;
      box-shadow:
        inset 3px 3px 6px #a3c79d,
        inset -3px -3px 6px #d7f0c2;
      background: #c0e6b7;
      color: #276b25;
    }
    body.dark #calculate-form select,
    body.dark #calculate-form input[type="number"] {
      background: #2a2e37;
      color: #a5dba0;
      box-shadow:
        inset 6px 6px 8px #1e2127,
        inset -6px -6px 8px #343a45;
    }
    body.dark #calculate-form select:focus,
    body.dark #calculate-form input[type="number"]:focus {
      background: #5aad5a;
      color: #2d602a;
      box-shadow:
        inset 3px 3px 6px #487a49,
        inset -3px -3px 6px #7dc27a;
    }

    /* Submit button */
    #calculate-form button[type="submit"],
    #refresh-btn,
    #settings-btn {
      background: #e6e6e6;
      box-shadow:
        6px 6px 12px #bebebe,
        -6px -6px 12px #ffffff;
      border: none;
      border-radius: 20px;
      padding: 0.8rem 1.6rem;
      font-weight: 700;
      color: #3a9a5a;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
      font-size: 1.1rem;
      margin-left: auto;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      user-select: none;
      justify-content: center;
    }
    #calculate-form button[type="submit"]:hover,
    #refresh-btn:hover,
    #settings-btn:hover {
      background: #c0e6b7;
      box-shadow:
        4px 4px 6px #a3c79d,
        -4px -4px 6px #d7f0c2;
      color: #276b25;
    }
    body.dark #calculate-form button[type="submit"],
    body.dark #refresh-btn,
    body.dark #settings-btn {
      background: #2a2e37;
      color: #5de57d;
      box-shadow:
        6px 6px 12px #1e2127,
        -6px -6px 12px #343a45;
    }
    body.dark #calculate-form button[type="submit"]:hover,
    body.dark #refresh-btn:hover,
    body.dark #settings-btn:hover {
      background: #5aad5a;
      color: #2d602a;
      box-shadow:
        4px 4px 6px #487a49,
        -4px -4px 6px #7dc27a;
    }

    /* Calculation result text */
    #calc-result {
      margin-top: 1rem;
      font-weight: 700;
      font-size: 1.1rem;
      color: #3a9a5a;
      user-select: text;
    }
    body.dark #calc-result {
      color: #5de57d;
    }

    /* Spinner style */
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3a9a5a;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin: 3rem auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg);}
      100% { transform: rotate(360deg);}
    }

    /* Error box */
    #error-box {
      max-width: 900px;
      margin: 1rem auto;
      background: #ffcccc;
      color: #a00000;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 700;
      box-shadow: 4px 4px 8px #aa0000;
      user-select: none;
      display: none;
      text-align: center;
    }

    /* Settings & Refresh buttons container */
    #top-controls {
      width: 900px;
      max-width: 100%;
      margin-bottom: 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      user-select: none;
    }
  </style>
</head>
<body>
  <header>
    <h1>Grow a Garden</h1>
    <p>Live Stock & Weather Monitor with Calculator & Info</p>
  </header>

  <section id="filters" aria-label="Filter categories">
    <label><input type="checkbox" id="seed_stock" checked /><span>Seeds</span></label>
    <label><input type="checkbox" id="gear_stock" checked /><span>Gear</span></label>
    <label><input type="checkbox" id="egg_stock" checked /><span>Eggs</span></label>
    <label><input type="checkbox" id="cosmetic_stock" checked /><span>Cosmetics</span></label>
    <label><input type="checkbox" id="eventshop_stock" checked /><span>Event Shop</span></label>
    <label><input type="checkbox" id="travelingmerchant_stock" checked /><span>Traveling Merchant</span></label>
    <label><input type="checkbox" id="weather" checked /><span>Weather</span></label>
  </section>

  <div id="top-controls">
    <button id="refresh-btn" aria-label="Refresh data">ðŸ”„ Refresh</button>
    <button id="settings-btn" aria-label="Toggle light/dark mode" title="Toggle light/dark mode">ðŸŒ— Mode</button>
  </div>

  <main id="output" role="main" aria-live="polite" aria-busy="false"></main>

  <section id="calculate-section" class="skeuocard" aria-label="Fruit Value Calculator">
    <form id="calculate-form" aria-describedby="calc-result">
      <select id="item-select" aria-label="Select an item">
        <option value="" selected disabled>Select an item...</option>
      </select>
      <input type="number" id="weight-input" min="0" step="0.01" placeholder="Weight (g)" aria-label="Enter weight in grams" required />
      <button type="submit" aria-label="Calculate value">Calculate</button>
    </form>
    <p id="calc-result" role="status" aria-live="polite"></p>
  </section>

  <div id="error-box" role="alert" aria-live="assertive"></div>

  <script>
    (function () {
      'use strict';

      const output = document.getElementById('output');
      const errorBox = document.getElementById('error-box');
      const filtersForm = document.getElementById('filters');
      const refreshBtn = document.getElementById('refresh-btn');
      const settingsBtn = document.getElementById('settings-btn');
      const calcForm = document.getElementById('calculate-form');
      const itemSelect = document.getElementById('item-select');
      const calcResult = document.getElementById('calc-result');

      let allItemsMap = new Map();
      let prevItems = {
        seed_stock: new Set(),
        gear_stock: new Set(),
        egg_stock: new Set(),
        cosmetic_stock: new Set(),
        eventshop_stock: new Set(),
        travelingmerchant_stock: new Set(),
      };

      const categories = {
        seed_stock: { key: 'seed_stock', title: 'Seeds', cssClass: 'category-seeds' },
        gear_stock: { key: 'gear_stock', title: 'Gear', cssClass: 'category-gear' },
        egg_stock: { key: 'egg_stock', title: 'Eggs', cssClass: 'category-eggs' },
        cosmetic_stock: { key: 'cosmetic_stock', title: 'Cosmetics', cssClass: 'category-cosmetics' },
        eventshop_stock: { key: 'eventshop_stock', title: 'Event Shop', cssClass: 'category-eventshop' },
        travelingmerchant_stock: { key: 'travelingmerchant_stock', title: 'Traveling Merchant', cssClass: 'category-travelingmerchant' },
      };

      // Spinner markup
      function createSpinner() {
        return `<div class="spinner" role="status" aria-label="Loading"></div>`;
      }

      // Render weather section
      function renderWeather(weather) {
        if (!weather.length) return null;
        const section = document.createElement('section');
        section.className = 'category skeuocard';
        section.setAttribute('aria-label', 'Current Weather');

        const h2 = document.createElement('h2');
        h2.textContent = 'Current Weather';
        section.appendChild(h2);

        weather.forEach(w => {
          const article = document.createElement('article');
          article.setAttribute('tabindex', '0');

          const img = document.createElement('img');
          img.src = w.icon;
          img.alt = w.weather_name;
          article.appendChild(img);

          const name = document.createElement('div');
          name.className = 'item-name';
          name.textContent = w.weather_name;
          article.appendChild(name);

          const duration = document.createElement('div');
          duration.className = 'quantity';
          duration.textContent = `Duration: ${Math.round(w.duration / 60)} min`;
          article.appendChild(duration);

          section.appendChild(article);
        });

        return section;
      }

      // Render a stock category section
      function renderStockCategory(items, title, cssClass, key) {
        const section = document.createElement('section');
        section.className = 'category skeuocard';
        section.setAttribute('aria-label', title);

        const h2 = document.createElement('h2');
        h2.textContent = title;
        section.appendChild(h2);

        items.forEach(item => {
          const article = document.createElement('article');
          article.setAttribute('tabindex', '0');

          // Item image
          const img = document.createElement('img');
          img.src = item.icon;
          img.alt = item.display_name;
          article.appendChild(img);

          // Item name
          const name = document.createElement('div');
          name.className = 'item-name';
          name.textContent = item.display_name;
          article.appendChild(name);

          // Quantity
          const quantity = document.createElement('div');
          quantity.className = 'quantity';
          quantity.textContent = `Stock: ${item.quantity}`;
          article.appendChild(quantity);

          // Dropdown container
          const dropdownWrapper = document.createElement('div');
          dropdownWrapper.className = 'dropdown relative ml-auto';
          dropdownWrapper.style.position = 'relative';

          // Dropdown button
          const dropdownBtn = document.createElement('button');
          dropdownBtn.className = 'dropdown-button';
          dropdownBtn.type = 'button';
          dropdownBtn.setAttribute('aria-haspopup', 'true');
          dropdownBtn.setAttribute('aria-expanded', 'false');
          dropdownBtn.textContent = 'Details â–¼';
          dropdownWrapper.appendChild(dropdownBtn);

          // Dropdown content
          const dropdownContent = document.createElement('div');
          dropdownContent.className = 'dropdown-content rounded-md shadow-md hidden max-w-xs';
          dropdownContent.setAttribute('aria-hidden', 'true');
          dropdownWrapper.appendChild(dropdownContent);

          article.appendChild(dropdownWrapper);

          // Toggle dropdown on button click
          dropdownBtn.addEventListener('click', async e => {
            e.stopPropagation();
            const isOpen = dropdownContent.classList.contains('show');
            // Close all other dropdowns
            document.querySelectorAll('.dropdown-content.show').forEach(dc => {
              if (dc !== dropdownContent) {
                dc.classList.remove('show');
                dc.setAttribute('aria-hidden', 'true');
              }
            });

            if (isOpen) {
              dropdownContent.classList.remove('show');
              dropdownContent.setAttribute('aria-hidden', 'true');
              dropdownBtn.setAttribute('aria-expanded', 'false');
            } else {
              dropdownContent.classList.add('show');
              dropdownContent.setAttribute('aria-hidden', 'false');
              dropdownBtn.setAttribute('aria-expanded', 'true');

              if (!dropdownContent.dataset.loaded) {
                dropdownContent.innerHTML = `<p class="text-gray-500">Loading...</p>`;
                try {
                  const res = await fetch(`https://api.joshlei.com/v2/growagarden/info/${item.item_id}`);
                  if (!res.ok) throw new Error(`HTTP ${res.status}`);
                  const data = await res.json();
                  let details = `<strong>${data.display_name || item.display_name}</strong><br/>`;
                  if (data.description) details += `<p class="mt-1 text-sm">${data.description}</p>`;
                  if (data.value) details += `<p class="mt-1 font-mono">Value: ${data.value}</p>`;
                  if (data.price) details += `<p class="mt-1 font-mono">Price: ${data.price}</p>`;
                  dropdownContent.innerHTML = details || `<p>No details available.</p>`;
                } catch {
                  dropdownContent.innerHTML = `<p class="text-red-500">Failed to load details.</p>`;
                }
                dropdownContent.dataset.loaded = "true";
              }
            }
          });

          section.appendChild(article);

          // Keyboard: toggle dropdown with Enter or Space
          article.addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              dropdownBtn.click();
            }
          });
        });

        return section;
      }

      // Populate calculate item select with all stock items
      async function populateCalculateSelect() {
        let allItems = [];
        Object.keys(prevItems).forEach(key => {
          prevItems[key].forEach(id => {
            const itm = allItemsMap.get(id);
            if (itm) allItems.push(itm);
          });
        });

        // Remove duplicates & sort alphabetically
        const uniqueItems = Array.from(new Map(allItems.map(i => [i.item_id, i])).values());
        uniqueItems.sort((a, b) => a.display_name.localeCompare(b.display_name));

        // Clear old options except placeholder
        itemSelect.querySelectorAll('option:not([disabled])').forEach(o => o.remove());

        uniqueItems.forEach(item => {
          const option = document.createElement('option');
          option.value = item.display_name;
          option.textContent = item.display_name;
          itemSelect.appendChild(option);
        });
      }

      // Calculate form submit handler
      calcForm.addEventListener('submit', async e => {
        e.preventDefault();
        const name = itemSelect.value;
        const weight = document.getElementById('weight-input').value;
        if (!name || !weight || weight <= 0) {
          calcResult.textContent = 'Please select an item and enter a valid weight.';
          return;
        }
        calcResult.textContent = 'Calculating...';

        try {
          const url = new URL('https://api.joshlei.com/v2/growagarden/calculate');
          url.searchParams.set('Name', name);
          url.searchParams.set('Weight', weight);
          const res = await fetch(url.toString());
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          calcResult.textContent = `Estimated value for ${data.Name} (${weight}g): ${data.value.toLocaleString()} coins`;
        } catch {
          calcResult.textContent = 'Failed to calculate value. Please try again later.';
        }
      });

      // Light/dark mode toggle logic
      function setDarkMode(isDark) {
        if (isDark) {
          document.body.classList.add('dark');
          localStorage.setItem('growagarden-darkmode', 'true');
          settingsBtn.textContent = 'ðŸŒž Mode';
        } else {
          document.body.classList.remove('dark');
          localStorage.setItem('growagarden-darkmode', 'false');
          settingsBtn.textContent = 'ðŸŒ— Mode';
        }
      }
      settingsBtn.addEventListener('click', () => {
        setDarkMode(!document.body.classList.contains('dark'));
      });
      // Init dark mode from storage
      setDarkMode(localStorage.getItem('growagarden-darkmode') === 'true');

      // Fetch data on manual refresh button click
      refreshBtn.addEventListener('click', fetchData);

      // Initial fetch on page load
      fetchData();

      // Fetch function (no auto refresh)
      async function fetchData() {
        output.setAttribute('aria-busy', 'true');
        errorBox.style.display = 'none';
        output.innerHTML = createSpinner();

        try {
          const [stockRes, weatherRes] = await Promise.all([
            fetch('https://api.joshlei.com/v2/growagarden/stock', { cache: 'no-store' }),
            fetch('https://api.joshlei.com/v2/growagarden/weather', { cache: 'no-store' }),
          ]);

          if (!stockRes.ok) throw new Error(`Stock API HTTP ${stockRes.status}`);
          if (!weatherRes.ok) throw new Error(`Weather API HTTP ${weatherRes.status}`);

          const stockData = await stockRes.json();
          const weatherData = await weatherRes.json();

          output.innerHTML = '';
          // Clear prevItems and allItemsMap
          Object.keys(prevItems).forEach(k => prevItems[k].clear());
          allItemsMap.clear();

          // Store new items and keep IDs for calculate select
          Object.entries(categories).forEach(([key, _]) => {
            const items = stockData[key] || [];
            items.forEach(i => {
              allItemsMap.set(i.item_id, i);
              prevItems[key].add(i.item_id);
            });
          });

          // Render weather section if checked
          if (document.getElementById('weather').checked && Array.isArray(weatherData.weather) && weatherData.weather.length) {
            const weatherSection = renderWeather(weatherData.weather);
            if (weatherSection) output.appendChild(weatherSection);
          }

          // Render categories that are checked
          Object.entries(categories).forEach(([filterId, { key, title, cssClass }]) => {
            if (document.getElementById(filterId).checked) {
              const items = stockData[key] || [];
              const section = renderStockCategory(items, title, cssClass, key);
              output.appendChild(section);
            }
          });

          await populateCalculateSelect();

        } catch (err) {
          output.innerHTML = '';
          errorBox.style.display = 'block';
          errorBox.textContent = 'Error Code 1: No internet or API limit reached. Please try again later.';
          console.error('Fetch error:', err);
        } finally {
          output.setAttribute('aria-busy', 'false');
        }
      }

      // Close dropdowns if clicking outside
      document.body.addEventListener('click', () => {
        document.querySelectorAll('.dropdown-content.show').forEach(dc => {
          dc.classList.remove('show');
          dc.setAttribute('aria-hidden', 'true');
        });
        document.querySelectorAll('.dropdown-button[aria-expanded="true"]').forEach(btn => {
          btn.setAttribute('aria-expanded', 'false');
        });
      });
    })();
  </script>
</body>
</html>
